<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="../resources/css/style.css">
</head>
<body>
<div class="wrap_contents">
  <div class="section_header">
    <h1>이력 그래프</h1>
    <span class="logo"></span>
    <span class="logo_dm"></span>
  </div>
  <div class="section_contents">
    <div class="area_contents area_user_graph">
      <div class="box_legend">
        <ul>
          <li>has_order</li>
          <li>has_product</li>
          <li>settlement</li><!-- 2020.0108 추가 -->
          <li>supplies</li>
        </ul>
      </div>

      <div class="box_legend_dot">
        <ul class="clearfix">
          <li><span></span>
            <p>member</p></li>
          <li><span></span>
            <p>order</p></li>
          <li><span></span>
            <p>product</p></li>
          <li><span></span>
            <p>cp</p></li>
          <li><span></span>
            <p>settlement</p></li><!-- 2020.0108 추가 -->
        </ul>
      </div>

      <div class="box_zoom">
        <span></span>
        <p>Wheel to zoom</p>
      </div>

      <div class="box_graph _userGraph"></div>
    </div>

  </div>

  <div class="section_button">
    <a href="#" class="btn btn-outline-success">닫기</a>
  </div>

</div>

<div class="popup_dim popup_dim_transparent _loader">
  <div class="box_loader">
    <div class="loader">Loading...</div>
  </div>
</div>

<script src="../resources/js/d3.min.js"></script>
<script src="../resources/js/ui.graph.js"></script>

<script>

  //API
  // const url1 = 'http://218.38.52.18:4000/channels/channel0/chaincodes/cc_dmp/graph/memberorder?peer=peer0.org1.kofpi.or.kr&fcn=queryAll&args=["201911","M_1000"]';
  // const url1 = 'http://graphbc9.cafe24.com:4000/channels/channel0/chaincodes/cc_dmp/graph/cpsettlement?peer=peer0.org1.kofpi.or.kr&fcn=queryAll&args=["202001","USRCNFRM_00000001093"]';
  // var url2 = 'http://graphbc9.cafe24.com:4000/channels/channel0/chaincodes/cc_dmp/graph/cporder?peer=peer0.org1.kofpi.or.kr&fcn=queryAll&args=["201912","USRCNFRM_00000001093"]';
  // const url3 = 'http://218.38.52.18:4000/channels/channel0/chaincodes/cc_dmp/graph/cpsettlement?peer=peer0.org1.kofpi.or.kr&fcn=queryAll&args=["201911","CP_1000"]';

  // const url1 = '../resources/json/graphdata_cp_settlement_dummy.json';

  const url1 = 'http://218.38.52.18:4000/channels/channel0/chaincodes/cc_dmp/graph/memberorder?peer=peer0.org1.kofpi.or.kr&fcn=queryAll&args=[%22201911%22,%22M_1000%22]';

  document.addEventListener("DOMContentLoaded", function () {
    graphInit(url1);
  });

  function graphInit(dataUrl) {

    //토큰 받기
    getToken();

    /**
     * renderGraph : 그래프
     * @param data
     * @returns {dmUi.view.graph}
     */
    const renderGraph = function (data) {
      const oGraphledger = new dmUi.view.graph();
      oGraphledger.drawGraph(data);
      return oGraphledger;
    };

    function getToken() {

      //토큰 API
      const tokenUrl = 'http://218.38.52.18:4000/users';
      let sToken = '';
      const elLoader = document.querySelector('._loader');

      const xhr = new XMLHttpRequest();
      const body = {
        "username": "user@org1",
        "orgName": "Org1",
      };


      xhr.open('POST', tokenUrl);
      xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
      xhr.send(JSON.stringify(body));

      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          elLoader.style.display = 'none';

          if (xhr.status === 200 || xhr.status === 201) {
            const data = JSON.parse(xhr.responseText);
            sToken = data.token;
            getData();
          }
        }
      };

      function getData() {
        const xhr = new XMLHttpRequest();

        //그래프 데이터 API
        const url = dataUrl;

        xhr.open('GET', url);
        xhr.setRequestHeader("Authorization", "Bearer " + sToken);
        xhr.send();

        xhr.onreadystatechange = function () {

          if (xhr.readyState === 4) {
            elLoader.style.display = 'none';

            if (xhr.status === 200 || xhr.status === 201) {
              const oData = JSON.parse(xhr.responseText);
              renderGraph(oData.result[0]);
            } else {
              console.error(xhr.responseText);
            }
          }
        };
      }

    }
  }

</script>
</body>
</html>