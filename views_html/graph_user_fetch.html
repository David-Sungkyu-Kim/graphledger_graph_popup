<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="../resources/css/style.css">
</head>
<body>
<div class="wrap_contents">
  <div class="section_header">
    <h1>이력 그래프</h1>
    <span class="logo"></span>
    <span class="logo_dm"></span>
  </div>
  <div class="section_contents">
    <div class="area_contents area_user_graph">
      <div class="box_legend">
        <ul>
          <li>has_order</li>
          <li>has_product</li>
          <li>supplies</li>
        </ul>
      </div>

      <div class="box_legend_dot _legendDot">
        <ul class="clearfix">
          <li><span></span>
            <p>member</p></li>
          <li><span></span>
            <p>order</p></li>
          <li><span></span>
            <p>product</p></li>
          <li><span></span>
            <p>cp</p></li>
        </ul>
      </div>

      <div class="box_zoom">
        <span></span>
        <p>Wheel to zoom</p>
      </div>

      <div class="box_graph _userGraph"></div>
    </div>

  </div>

  <div class="section_button">
    <a href="#" class="btn btn-outline-success">닫기</a>
  </div>

</div>
<script src="../resources/js/es-6promise.min.js"></script>
<script src="../resources/js/es-6-promise.auto.min.js"></script>
<script src="../resources/js/fetch.min.js"></script>
<script src="../resources/js/d3.min.js"></script>
<script src="../resources/js/ui.graph.js"></script>

<script>

  document.addEventListener("DOMContentLoaded", graphInit);

  function graphInit() {

    //토큰 받기
    getToken();

    /**
     * renderGraph : 그래프
     * @param data
     * @returns {dmUi.view.graph}
     */
    const renderGraph = function (data) {
      const oGraphledger = new dmUi.view.graph();
      oGraphledger.drawGraph(data);
      return oGraphledger;
    };

    function getToken() {

      //토큰 API
      const url = 'http://218.38.52.18:4000/users';

      const xhr = new XMLHttpRequest();
      const body = {
        "username": "user@org1",
        "orgName": "Org1",
      };

      let sToken = '';

      xhr.open('POST', url);
      xhr.setRequestHeader('Content-Type', 'application/json; charset=utf-8');
      xhr.send(JSON.stringify(body));

      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          const data = JSON.parse(xhr.responseText);
          sToken = data.token;
          getData();
        }
      };

      async function getData() {
        //그래프 데이터 API
        const url = 'http://218.38.52.18:4000/channels/channel0/chaincodes/cc_dmp/graph/memberorder?peer=peer0.org1.kofpi.or.kr&fcn=queryAll&args=["201911","M_1000"]';

        const response = await fetch(url, {
          headers: new Headers({
            "Authorization": "Bearer " + sToken
          })
        });

        let data = null;

        try {
          if(response.ok) {
            const responseData = await response.json();
            data = responseData.result[0];
            renderGraph(data);

          } else {
            return console.error({
              status: response.status,
              statusText: response.statusText
            });
          }
        } catch (err) {
          console.log(err);
        }

      }

    }
  }

</script>
</body>
</html>